# 剧集管理

## Purpose
剧集管理提供用户创建和管理作品（漫剧系列）及其剧集的功能。它包括从脚本输入到分镜生成、基于分镜的内容创建（图片、视频、音频）以及剧集预览的完整工作流程。

## Requirements

### 需求：作品列表管理
系统必须提供作品列表页面，用户可以：
- 查看所有作品
- 创建新作品
- 访问作品详情编辑
- 访问每个作品的剧集列表管理

#### 场景：查看作品列表
- **当** 用户导航到作品列表页面
- **则** 所有作品以列表形式显示
- **且** 每个作品显示封面图片、名称和描述预览
- **且** 每个作品有"编辑详情"和"编辑剧集"操作可用

#### 场景：创建新作品
- **当** 用户点击"创建新作品"按钮
- **且** 填写作品名称和描述
- **且** 提交表单
- **则** 新作品文件夹在 `data/works/{work_id}/` 创建
- **且** 使用默认值创建 `meta.json`
- **且** 用户重定向到作品详情编辑页面

### 需求：作品详情编辑
系统必须允许用户编辑作品详情，包括：
- 作品名称
- 作品描述
- 封面图片（支持多张不同宽高比的图片）
- 风格描述
- 默认视频宽高比（9:16、16:9、4:3、3:4）
- 素材关联（人物、场景、道具素材）

#### 场景：编辑作品名称和描述
- **当** 用户在作品上点击"编辑详情"
- **且** 修改作品名称或描述
- **且** 保存更改
- **则** `data/works/{work_id}/meta.json` 使用新名称和描述更新
- **且** 更改反映在作品列表中

#### 场景：上传封面图片
- **当** 用户在作品详情编辑页面
- **且** 上传一张或多张封面图片
- **且** 保存更改
- **则** 封面图片保存到 `data/works/{work_id}/covers/`
- **且** 图片路径记录在 `meta.json` 中
- **且** 图片可以有不同的宽高比

#### 场景：编辑风格描述
- **当** 用户在作品详情编辑页面
- **且** 修改风格描述文本
- **且** 保存更改
- **则** 风格描述保存到 `meta.json`
- **且** 风格描述用作内容生成的上下文

#### 场景：设置默认宽高比
- **当** 用户在作品详情编辑页面
- **且** 选择默认宽高比（9:16、16:9、4:3 或 3:4）
- **且** 保存更改
- **则** 默认宽高比保存到 `meta.json`
- **且** 此宽高比用作剧集内容生成的默认值

#### 场景：查看作品关联的素材
- **当** 用户在作品详情编辑页面
- **则** 页面显示三个素材管理区域：
  - 人物素材列表
  - 场景素材列表
  - 道具素材列表
- **且** 每个区域显示当前作品关联的该类型素材列表
- **且** 每个素材显示图片、名称和删除按钮
- **且** 如果某个类型没有关联素材，显示"暂无素材"提示

#### 场景：添加人物素材
- **当** 用户在作品详情编辑页面
- **且** 点击"添加人物素材"按钮
- **则** 系统打开素材多选面板
- **且** 多选面板只显示人物类型的素材（筛选标签只显示"人物"或隐藏筛选标签）
- **当** 用户选择一个或多个素材
- **且** 点击"确认"按钮
- **则** 系统将选中的素材添加到作品的人物素材列表
- **且** 如果某些素材已经在列表中，自动去重（不重复添加）
- **且** 更新页面显示，显示新添加的素材
- **且** 保存作品数据到后端

#### 场景：添加场景素材
- **当** 用户在作品详情编辑页面
- **且** 点击"添加场景素材"按钮
- **则** 系统打开素材多选面板
- **且** 多选面板只显示场景类型的素材
- **当** 用户选择一个或多个素材
- **且** 点击"确认"按钮
- **则** 系统将选中的素材添加到作品的场景素材列表
- **且** 自动去重
- **且** 更新页面显示
- **且** 保存作品数据到后端

#### 场景：添加道具素材
- **当** 用户在作品详情编辑页面
- **且** 点击"添加道具素材"按钮
- **则** 系统打开素材多选面板
- **且** 多选面板只显示道具类型的素材
- **当** 用户选择一个或多个素材
- **且** 点击"确认"按钮
- **则** 系统将选中的素材添加到作品的道具素材列表
- **且** 自动去重
- **且** 更新页面显示
- **且** 保存作品数据到后端

#### 场景：删除关联的素材
- **当** 用户在作品详情编辑页面
- **且** 在某个素材项上点击"删除"按钮
- **且** 确认删除
- **则** 系统从对应类型的素材列表中移除该素材
- **且** 更新页面显示
- **且** 保存作品数据到后端

#### 场景：素材去重
- **当** 用户添加素材到作品
- **且** 选中的素材中有些已经在对应类型的列表中
- **则** 系统自动过滤掉已存在的素材
- **且** 只添加新的素材
- **且** 如果所有选中的素材都已存在，显示提示信息

### 需求：作品数据结构扩展
系统必须在作品的元数据中存储关联的素材ID列表。

#### 场景：创建作品时的默认数据
- **当** 系统创建新作品时
- **则** 在 `meta.json` 中包含以下字段：
  - `character_materials: []`（人物素材ID列表）
  - `scene_materials: []`（场景素材ID列表）
  - `prop_materials: []`（道具素材ID列表）

#### 场景：更新作品素材关联
- **当** 用户添加或删除素材关联
- **且** 保存作品数据
- **则** 系统更新 `meta.json` 中对应的素材ID列表
- **且** 保持其他字段不变

#### 场景：加载作品素材关联
- **当** 系统加载作品详情时
- **则** 从 `meta.json` 读取素材ID列表
- **且** 根据ID列表获取素材详情
- **且** 如果某个素材不存在（可能已被删除），跳过该素材或显示占位符
- **且** 在页面上显示素材列表

### 需求：剧集列表管理
系统必须为每个作品提供剧集列表管理，允许用户：
- 查看作品中的所有剧集
- 创建新剧集
- 编辑剧集详情
- 访问剧集编辑工作流

#### 场景：查看剧集列表
- **当** 用户在作品上点击"编辑剧集"
- **则** 该作品的所有剧集以列表形式显示
- **且** 每个剧集显示封面图片、名称和描述预览
- **且** 每个剧集有"编辑详情"和"编辑剧集"操作可用

#### 场景：创建新剧集
- **当** 用户点击"创建新剧集"按钮
- **且** 填写剧集名称和描述
- **且** 提交表单
- **则** 新剧集文件夹在 `data/works/{work_id}/episodes/{episode_id}/` 创建
- **且** 使用剧集名称和描述创建 `meta.json`
- **且** 用户重定向到剧集编辑工作流页面

### 需求：剧集详情编辑
系统必须允许用户编辑剧集详情，包括：
- 剧集名称
- 剧集描述
- 剧集封面图片

#### 场景：编辑剧集名称和描述
- **当** 用户在剧集上点击"编辑详情"
- **且** 修改剧集名称或描述
- **且** 保存更改
- **则** `data/works/{work_id}/episodes/{episode_id}/meta.json` 更新
- **且** 更改反映在剧集列表中

#### 场景：上传剧集封面
- **当** 用户在剧集详情编辑页面
- **且** 上传封面图片
- **且** 保存更改
- **则** 封面图片保存到剧集文件夹
- **且** 封面图片路径记录在 `meta.json` 中

### 需求：剧集编辑工作流
系统必须提供编辑剧集的工作流，包括：
1. 带预期时长的剧本输入
2. 从剧本生成分镜脚本（调用LLM接口）
3. 分镜脚本编辑和确认
4. 分镜卡片生成（调用LLM接口生成提示词）
5. 分镜卡片管理
6. 内容生成（图片、视频、音频）
7. 预览功能

#### 场景：输入剧本并生成分镜脚本文本
- **当** 用户在剧集编辑页面
- **且** 在输入框中输入剧本文本
- **且** 设置预期剧集时长
- **且** 保存剧本
- **则** 剧本保存到 `data/works/{work_id}/episodes/{episode_id}/script.json`
- **且** 剧本文本和预期时长被存储
- **当** 用户点击"生成分镜脚本"按钮
- **则** 系统使用剧本文本调用 LLM API
- **且** LLM 返回分镜脚本文本（大段文本格式）
- **且** 分镜脚本文本保存到 `data/works/{work_id}/episodes/{episode_id}/storyboard.json` 的 `text` 字段
- **且** `confirmed` 字段设置为 `false`
- **且** 分镜脚本编辑区域显示，允许用户查看和编辑分镜脚本文本
- **且** 剧本输入框变为只读，显示"重新编辑剧本"按钮

#### 场景：编辑和保存分镜脚本文本
- **当** 分镜脚本文本已生成
- **且** 用户在分镜脚本编辑区域编辑文本
- **且** 点击"保存分镜脚本"按钮
- **则** 编辑后的分镜脚本文本保存到 `storyboard.json` 的 `text` 字段
- **且** 用户收到保存成功的提示

#### 场景：生成分镜卡片
- **当** 分镜脚本文本已保存
- **且** 用户点击"生成分镜"按钮
- **则** 系统解析分镜脚本文本，生成结构化分镜数据
- **且** 为每个分镜的描述调用 LLM API 生成图片提示词、视频提示词和音频提示词
- **且** 结构化数据保存到 `storyboard.json` 的 `shots` 字段
- **且** `confirmed` 字段设置为 `true`
- **且** 基于结构化数据创建分镜卡片列表
- **且** 分镜脚本编辑区域隐藏，分镜卡片列表区域显示

#### 场景：查看分镜卡片列表
- **当** 分镜脚本已确认
- **则** 分镜卡片以网格布局显示
- **且** 每行显示3个分镜卡片
- **且** 支持向下滚动查看更多卡片
- **且** 每个卡片显示分镜编号（分镜 1、分镜 2...）

#### 场景：查看分镜卡片字段（浏览模式）
- **当** 分镜卡片已显示
- **则** 每个分镜卡片包含4个文本字段：
  - 分镜描述（总体描述）
  - 图片提示词
  - 视频提示词
  - 音频提示词
- **且** 分镜描述单独显示
- **且** 图片、视频、音频三个提示词通过Tab切换显示
- **且** 每个字段默认以浏览模式显示（只读文本）
- **且** 每个字段旁边显示"编辑"按钮

#### 场景：编辑分镜卡片字段
- **当** 用户在分镜卡片上点击某个字段的"编辑"按钮
- **则** 该字段切换到编辑模式
- **且** 文本内容显示在可编辑的文本框中（textarea）
- **且** "编辑"按钮变为"保存"和"取消"按钮
- **且** 其他字段保持浏览模式

#### 场景：保存分镜卡片字段
- **当** 用户在编辑模式下修改字段内容
- **且** 点击"保存"按钮
- **则** 修改后的内容保存到 `storyboard.json` 中对应分镜的数据
- **且** 字段切换回浏览模式
- **且** 显示更新后的内容
- **且** 用户收到保存成功的提示

#### 场景：取消编辑分镜卡片字段
- **当** 用户在编辑模式下
- **且** 点击"取消"按钮
- **则** 字段切换回浏览模式
- **且** 显示原始内容（未保存的修改被丢弃）

#### 场景：生成分镜内容（图片/视频/音频）
- **当** 分镜卡片已显示
- **且** 用户在对应的Tab面板中点击"生成图片"、"生成视频"或"生成音频"按钮
- **则** 系统使用对应字段的提示词调用相应的AI API
- **且** 生成的内容保存到对应的文件夹
- **且** 内容在对应的Tab面板中显示

#### 场景：生成候选图片
- **当** 用户在分镜卡片的"图片"Tab中点击"生成图片"按钮
- **则** 系统使用图片提示词调用文本生成图片 API
- **且** 生成 3 张候选图片
- **且** 图片保存到 `data/works/{work_id}/episodes/{episode_id}/shots/{shot_id}/images/candidate_{1,2,3}.jpg`
- **且** 图片在"图片"Tab面板中显示供用户选择
- **且** 用户可以选择一张图片或重新生成

#### 场景：从候选图片中选择
- **当** 显示 3 张候选图片
- **且** 用户点击其中一张图片
- **则** 选中的图片标记为活动状态
- **且** 选中的图片路径保存到分镜元数据
- **且** 选中的图片在预览中使用

#### 场景：重新生成图片
- **当** 用户在分镜卡片上点击"重新生成图片"
- **则** 之前的候选图片移动到历史文件夹
- **且** 生成 3 张新的候选图片
- **且** 新图片显示供选择

#### 场景：查看图片历史
- **当** 用户在分镜卡片上点击"查看历史"
- **则** 显示所有之前生成的图片
- **且** 用户可以选择任何历史图片使用
- **且** 选中的历史图片成为活动图片

#### 场景：生成视频
- **当** 用户在分镜卡片的"视频"Tab中点击"生成视频"按钮
- **则** 系统使用视频提示词调用文本生成视频 API
- **且** 视频生成并保存到 `data/works/{work_id}/episodes/{episode_id}/shots/{shot_id}/videos/video_{timestamp}.mp4`
- **且** 视频路径保存到分镜元数据
- **且** 视频在"视频"Tab面板中显示

#### 场景：重新生成视频
- **当** 用户在分镜卡片上点击"重新生成视频"
- **则** 之前的视频移动到历史文件夹
- **且** 生成新视频
- **且** 新视频替换当前视频

#### 场景：查看视频历史
- **当** 用户在分镜卡片上点击"查看历史"
- **则** 显示所有之前生成的视频
- **且** 用户可以选择任何历史视频使用
- **且** 选中的历史视频成为活动视频

#### 场景：生成音频
- **当** 用户在分镜卡片的"音频"Tab中点击"生成音频"按钮
- **则** 系统使用音频提示词（对话描述）调用 TTS API
- **且** 音频生成并保存到 `data/works/{work_id}/episodes/{episode_id}/shots/{shot_id}/audio/audio_{timestamp}.mp3`
- **且** 音频路径保存到分镜元数据
- **且** 音频播放器在"音频"Tab面板中显示

#### 场景：重新生成音频
- **当** 用户在分镜卡片上点击"重新生成音频"
- **则** 之前的音频移动到历史文件夹
- **且** 生成新音频
- **且** 新音频替换当前音频

#### 场景：查看音频历史
- **当** 用户在分镜卡片上点击"查看历史"
- **则** 显示所有之前生成的音频文件
- **且** 用户可以选择任何历史音频使用
- **且** 选中的历史音频成为活动音频

#### 场景：预览剧集
- **当** 用户点击"预览剧集"按钮
- **则** 系统按顺序加载所有分镜
- **且** 对于每个分镜：
  - **如果** 存在视频，播放视频
  - **否则如果** 存在图片，显示图片持续预期分镜时长
- **且** 音频与视频/图片同步播放
- **且** 预览显示完整的剧集序列

#### 场景：预览时缺少内容
- **当** 用户点击"预览剧集"
- **且** 某些分镜没有视频或图片
- **则** 这些分镜被跳过或显示为占位符
- **且** 预览继续使用可用内容
- **且** 用户收到缺少内容的通知

### 需求：剧集预览功能增强
系统必须在剧集编辑页面提供可切换的预览面板，显示在"剧本关联素材"和"分镜管理"之间，连续播放所有分镜的内容，并在视频/图片下方居中显示台词字幕。

#### 场景：显示预览面板
- **当** 用户在剧集编辑页面
- **且** 点击"预览剧集"按钮
- **且** 预览面板当前隐藏
- **则** 系统在"剧本关联素材"和"分镜管理"之间显示预览面板
- **且** 预览面板包含标题"剧集预览"和关闭按钮
- **且** 开始按顺序播放/显示所有分镜的内容

#### 场景：隐藏预览面板
- **当** 预览面板已显示
- **且** 用户点击预览面板的关闭按钮
- **则** 系统隐藏预览面板
- **且** 停止当前播放的内容
- **且** 清除当前显示的字幕

#### 场景：切换预览面板
- **当** 用户点击"预览剧集"按钮
- **且** 预览面板当前显示
- **则** 系统隐藏预览面板
- **且** 停止当前播放的内容
- **且** 清除当前显示的字幕
- **当** 用户再次点击"预览剧集"按钮
- **且** 预览面板当前隐藏
- **则** 系统显示预览面板
- **且** 重新开始播放所有分镜的内容

#### 场景：连续播放分镜内容
- **当** 预览面板已显示
- **则** 系统按分镜顺序连续播放/显示每个分镜的内容
- **且** 对于每个分镜，按以下优先级选择内容：
  1. **如果** 分镜有参考tab的视频（`current_video`），播放该视频
  2. **否则如果** 分镜有视频tab的视频（`video`），播放该视频
  3. **否则如果** 分镜有已选择的图片（`selected_image`），显示该图片持续分镜的预期时长（`duration`秒）
  4. **否则如果** 分镜有候选图片，显示第一张候选图片持续分镜的预期时长
- **且** 视频播放结束后自动播放下一个分镜的内容
- **且** 图片显示指定时长后自动切换到下一个分镜的内容
- **且** 如果分镜没有任何内容，跳过该分镜继续下一个

#### 场景：视频播放控制
- **当** 预览面板播放视频内容
- **则** 视频自动开始播放
- **且** 视频播放结束后（`ended` 事件），自动切换到下一个分镜的内容
- **且** 如果视频加载失败，自动切换到下一个分镜的内容

#### 场景：图片显示控制
- **当** 预览面板显示图片内容
- **则** 图片显示在预览区域
- **且** 图片持续显示分镜的预期时长（`duration` 秒）
- **且** 显示时长结束后，自动切换到下一个分镜的内容
- **且** 如果图片加载失败，显示占位符持续1秒后切换到下一个分镜

#### 场景：预览时缺少内容（预览面板）
- **当** 用户点击"预览剧集"
- **且** 某些分镜没有视频或图片
- **则** 这些分镜被跳过
- **且** 预览继续使用可用内容
- **且** 如果所有分镜都没有内容，显示提示信息："暂无可预览的内容"

#### 场景：显示台词字幕
- **当** 预览面板播放或显示分镜内容
- **且** 分镜包含 `dialogue_prompt` 字段
- **且** `dialogue_prompt` 不为空
- **则** 系统解析 `dialogue_prompt`，提取时间范围和对应的台词内容
- **且** 在视频/图片下方居中显示字幕容器
- **且** 根据当前播放时间或显示时间，动态显示对应的台词字幕
- **且** 字幕显示格式为：角色描述和台词内容（例如：【刘备，身着白色长袍，神情坚定】:"天若有情天亦老，"）

#### 场景：台词字幕时间同步
- **当** 预览面板播放视频内容
- **且** 分镜包含台词提示词
- **则** 系统监听视频的 `timeupdate` 事件
- **且** 当视频播放时间进入某个台词的时间范围时（例如：3～4秒），显示该台词字幕
- **且** 当视频播放时间离开某个台词的时间范围时，隐藏该台词字幕
- **且** 支持多个台词片段按时间顺序显示和隐藏

#### 场景：图片显示时的台词字幕
- **当** 预览面板显示图片内容
- **且** 分镜包含台词提示词
- **则** 系统根据图片显示的开始时间（从0秒开始）和持续时间（`duration` 秒）
- **且** 按时间顺序显示对应的台词字幕
- **且** 当图片显示时间进入某个台词的时间范围时，显示该台词字幕
- **且** 当图片显示时间离开某个台词的时间范围时，隐藏该台词字幕

#### 场景：分镜切换时的字幕清除
- **当** 预览面板切换到下一个分镜
- **则** 系统清除当前显示的字幕
- **且** 如果新分镜包含台词提示词，开始显示新分镜的字幕

#### 场景：没有台词提示词时的字幕显示
- **当** 预览面板播放或显示分镜内容
- **且** 分镜不包含 `dialogue_prompt` 字段
- **或** `dialogue_prompt` 为空字符串
- **则** 系统不显示字幕容器
- **且** 预览区域只显示视频或图片内容

#### 场景：台词解析失败处理
- **当** 预览面板尝试解析分镜的 `dialogue_prompt`
- **且** 台词提示词格式不正确或解析失败
- **则** 系统不显示字幕
- **或** 显示错误提示（可选）
- **且** 预览功能继续正常工作，不影响视频/图片的播放和显示

