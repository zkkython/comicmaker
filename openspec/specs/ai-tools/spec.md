# ai-tools Specification

## Purpose
TBD - created by archiving change add-ai-tools. Update Purpose after archive.
## 需求
### 需求：工具页面导航
系统必须在主要页面添加"工具"Tab，用户可以导航到工具页面。

#### 场景：访问工具页面
- **当** 用户在主要页面
- **且** 点击导航栏中的"工具"链接
- **则** 用户导航到工具页面
- **且** 工具页面显示所有可用的 AI 工具

### 需求：生成剧本工具
系统必须使用 OpenRouter LLM 接口根据用户描述生成详细的剧本文本，替换现有的 mock 实现。

#### 场景：使用 LLM 生成剧本
- **当** 用户在工具页面使用"生成剧本"工具
- **且** 输入描述文本并提交
- **则** 系统加载提示词模板文件 `server/prompts/generation/script_generation.txt`
- **且** 将用户描述替换到提示词模板的变量位置
- **且** 从配置文件读取 LLM 配置（模型、API Key）
- **且** 调用 OpenRouter LLM 接口生成剧本
- **且** 返回生成的详细剧本文本（包含人物、情节、对话等）
- **且** 如果 LLM 调用失败，任务状态标记为失败并返回错误信息

#### 场景：提示词模板管理
- **当** 系统需要生成剧本时
- **则** 从 `server/prompts/generation/script_generation.txt` 加载提示词模板
- **且** 提示词使用中文编写
- **且** 提示词包含变量占位符（如 `{description}`）用于替换用户输入
- **且** 提示词应包含系统角色定义、任务目标和输出要求

#### 场景：LLM 配置读取
- **当** 系统需要调用 LLM 接口时
- **则** 从 `server/config/config.yaml` 读取 `llm` 配置
- **且** 获取 `model` 字段（LLM 模型名称）
- **且** 获取 `openai_api_key` 字段（OpenRouter API Key）
- **且** 使用这些配置调用 `query_openrouter` 函数

### 需求：生成分镜脚本工具
系统必须提供生成分镜脚本工具，用户输入剧本文本，系统生成分镜脚本。

#### 场景：使用生成分镜脚本工具
- **当** 用户在工具页面
- **且** 点击"生成分镜脚本"工具卡片
- **则** 显示生成分镜脚本表单
- **且** 表单包含剧本文本输入框
- **当** 用户输入剧本文本
- **且** 点击"生成"按钮
- **则** 系统创建任务并返回任务ID
- **且** 前端开始轮询任务状态
- **且** 任务完成后显示生成的分镜脚本（格式：分镜1: ... 分镜2: ...）
- **且** 生成结果保存到历史记录

### 需求：基于图生描述工具
系统必须使用 OpenRouter LLM 接口根据用户上传的图片和描述生成详细的描述设定，替换现有的 mock 实现。

#### 场景：使用 LLM 生成图片描述
- **当** 用户在工具页面使用"基于图生描述"工具
- **且** 上传图片、选择类型（人物/场景/道具）并可选提供额外描述
- **且** 点击"生成"按钮
- **则** 系统加载提示词模板文件 `server/prompts/generation/image_to_description.txt`
- **且** 将图片编码为 base64 格式
- **且** 将用户选择的类型和描述替换到提示词模板的变量位置
- **且** 从配置文件读取 LLM 配置（模型、API Key）
- **且** 调用 OpenRouter LLM 接口（支持多模态输入：图片 + 文本）
- **且** 返回生成的详细描述文本（100字以内）
- **且** 如果 LLM 调用失败，任务状态标记为失败并返回错误信息

#### 场景：提示词模板管理
- **当** 系统需要生成图片描述时
- **则** 从 `server/prompts/generation/image_to_description.txt` 加载提示词模板
- **且** 提示词使用中文编写
- **且** 提示词包含变量占位符（如 `{material_type}`、`{user_description}`）用于替换用户输入
- **且** 提示词应包含系统角色定义、任务目标和输出要求
- **且** 根据用户选择的类型（人物/场景/道具）调整描述重点

#### 场景：多模态输入处理
- **当** 系统需要调用 LLM 接口生成图片描述时
- **则** 将图片文件编码为 base64 格式
- **且** 构建多模态消息（包含图片和文本提示词）
- **且** 如果用户提供了额外描述，将其包含在用户消息中
- **且** 使用 OpenRouter API 的多模态能力处理图片和文本输入

#### 场景：LLM 配置读取
- **当** 系统需要调用 LLM 接口时
- **则** 从 `server/config/config.yaml` 读取 `llm` 配置
- **且** 获取 `model` 字段（LLM 模型名称，需支持多模态）
- **且** 获取 `openai_api_key` 字段（OpenRouter API Key）
- **且** 使用这些配置调用 OpenRouter API

### 需求：文生图工具
系统必须提供文生图工具，支持多个模型切换、分辨率选择和类型选择，根据用户输入的文字描述生成图片。

#### 场景：使用文生图工具
- **当** 用户在工具页面
- **且** 点击"文生图"工具卡片
- **则** 显示文生图表单
- **且** 表单包含文字输入框、类型选择（人物/场景/道具）、模型选择、分辨率比例选择、分辨率选择
- **当** 用户输入文字描述、选择类型、模型、比例和分辨率
- **且** 点击"生成"按钮
- **则** 系统创建任务并返回任务ID
- **且** 前端开始轮询任务状态
- **且** 任务完成后显示生成的图片
- **且** 生成结果保存到历史记录

#### 场景：模型切换
- **当** 用户在文生图工具表单中
- **且** 选择不同的模型（seedream4.5、wan2.6、nanopro）
- **则** 系统记录用户选择的模型
- **且** 提交任务时使用对应的模型 API
- **且** 默认使用 seedream4.5 模型

#### 场景：分辨率参数处理
- **当** 用户选择分辨率比例（1:1, 3:4, 4:3, 16:9, 9:16）和分辨率（1k、2k）
- **且** 选择的模型是 seedream 或 wan
- **则** 系统根据比例和分辨率计算宽高值（格式：`"1024*1024"`）
- **且** 调用 API 时传入 `size` 参数
- **当** 选择的模型是 banana
- **则** 系统直接使用比例和分辨率值
- **且** 调用 API 时传入 `aspect_ratio` 和 `resolution` 参数

#### 场景：API 调用
- **当** 系统需要生成图片时
- **且** 模型是 seedream4.5
- **则** 调用 `seedream_v4_5_text_to_image` 函数
- **且** 传入 `prompt` 和计算后的 `size` 参数
- **当** 模型是 wan2.6
- **则** 调用 `wan_2_6_text_to_image` 函数
- **且** 传入 `prompt` 和计算后的 `size` 参数
- **当** 模型是 nanopro
- **则** 调用 `nano_banana_pro_text_to_image` 函数
- **且** 传入 `prompt`、`aspect_ratio` 和 `resolution` 参数

### 需求：图生图工具
系统必须提供图生图工具，支持多个模型切换、分辨率选择和多图片管理，根据用户上传的参考图片和文字描述生成新图片。

#### 场景：使用图生图工具
- **当** 用户在工具页面
- **且** 点击"图生图"工具卡片
- **则** 显示图生图表单
- **且** 表单包含文字输入框、多图片上传区域、模型选择、分辨率比例选择、分辨率选择
- **当** 用户输入文字描述、上传图片、选择模型、比例和分辨率
- **且** 点击"生成"按钮
- **则** 系统创建任务并返回任务ID
- **且** 前端开始轮询任务状态
- **且** 任务完成后显示生成的图片
- **且** 生成结果保存到历史记录

#### 场景：多图片上传和管理
- **当** 用户在图生图工具表单中
- **且** 点击上传按钮或粘贴图片
- **则** 图片添加到图片列表
- **且** 显示图片缩略图预览
- **且** 每个图片显示删除按钮
- **当** 用户点击删除按钮
- **则** 对应的图片从列表中移除
- **且** 更新预览显示

#### 场景：图片拖拽排序
- **当** 用户在图生图工具表单中
- **且** 拖拽图片缩略图
- **则** 显示拖拽状态（半透明、边框高亮）
- **且** 显示插入位置指示
- **当** 用户释放鼠标
- **则** 图片移动到新位置
- **且** 更新图片列表顺序
- **且** 提交时按照新的顺序提交图片

#### 场景：模型切换
- **当** 用户在图生图工具表单中
- **且** 选择不同的模型（seedream4.5、wan2.6、nanopro）
- **则** 系统记录用户选择的模型
- **且** 提交任务时使用对应的模型 API
- **且** 默认使用 seedream4.5 模型

#### 场景：分辨率参数处理
- **当** 用户选择分辨率比例（1:1, 3:4, 4:3, 16:9, 9:16）和分辨率（1k、2k）
- **且** 选择的模型是 seedream 或 wan
- **则** 系统根据比例和分辨率计算宽高值（格式：`"1024*1024"`）
- **且** 调用 API 时传入 `size` 参数
- **当** 选择的模型是 banana
- **则** 系统直接使用比例和分辨率值
- **且** 调用 API 时传入 `aspect_ratio` 和 `resolution` 参数

#### 场景：API 调用
- **当** 系统需要生成图片时
- **且** 模型是 seedream4.5
- **则** 调用 `seedream_v4_edit` 函数（已存在）
- **且** 传入 `prompt`、`images`（按顺序）和计算后的 `size` 参数
- **当** 模型是 wan2.6
- **则** 调用 `wan_2_6_image_edit` 函数
- **且** 传入 `prompt`、`images`（按顺序）和计算后的 `size` 参数
- **当** 模型是 nanopro
- **则** 调用 `nano_banana_pro_edit` 函数
- **且** 传入 `prompt`、`images`（按顺序）、`aspect_ratio` 和 `resolution` 参数

### 需求：工具列表 UI 优化
系统必须优化左侧工具列表的显示，缩小每个工具项的高度。

#### 场景：工具列表样式调整
- **当** 用户在工具页面
- **则** 左侧工具列表每个工具项的高度缩小 30%
- **且** 保持工具图标和名称的可读性
- **且** 保持工具列表的整体美观

### 需求：vidu 参考生视频工具
系统必须提供 vidu 参考生视频工具，用户上传最多7张图片、输入文字描述、选择分辨率和时长，系统使用 `vidu/reference-to-video-q2` 模型生成视频。

#### 场景：使用 vidu 参考生视频工具
- **当** 用户在工具页面
- **且** 点击"vidu参考生视频"工具卡片
- **则** 显示 vidu 参考生视频表单
- **且** 表单包含：
  - 多图片上传组件（最多7张，支持上传/粘贴/选择素材）
  - 图片拖拽排序功能
  - 图片删除功能
  - 文字描述输入框
  - 分辨率选择（1:1, 3:4, 4:3, 16:9, 9:16，默认16:9）
  - 分辨率选择（540p, 720p, 1080p）
  - 时长选择（1-10秒，默认5秒）
- **当** 用户上传图片（最多7张）、输入文字描述、选择分辨率和时长
- **且** 点击"生成"按钮
- **则** 系统将图片上传到 OSS 获取 URL
- **且** 按照页面上的图片顺序提交到 API
- **且** 系统创建任务并返回任务ID
- **且** 前端开始轮询任务状态
- **且** 任务完成后显示生成的视频
- **且** 生成结果保存到历史记录

#### 场景：图片顺序管理
- **当** 用户在 vidu 参考生视频工具中上传多张图片
- **且** 拖拽图片调整顺序
- **则** 系统记录图片的新顺序
- **且** 提交时按照显示的顺序将图片 URL 传递给 API

#### 场景：图片数量限制
- **当** 用户在 vidu 参考生视频工具中上传图片
- **且** 图片数量已达到7张
- **则** 系统禁止继续添加图片
- **且** 显示提示信息

### 需求：sora 生视频工具
系统必须提供 sora 生视频工具，用户上传单张图片、输入文字描述、选择时长，系统使用 `openai/sora-2/image-to-video` 模型生成视频。

#### 场景：使用 sora 生视频工具
- **当** 用户在工具页面
- **且** 点击"sora生视频"工具卡片
- **则** 显示 sora 生视频表单
- **且** 表单包含：
  - 单图片上传组件（支持上传/粘贴/选择素材）
  - 文字描述输入框
  - 时长选择（4、8、12秒）
- **当** 用户上传图片、输入文字描述、选择时长
- **且** 点击"生成"按钮
- **则** 系统将图片上传到 OSS 获取 URL
- **且** 系统创建任务并返回任务ID
- **且** 前端开始轮询任务状态
- **且** 任务完成后显示生成的视频
- **且** 生成结果保存到历史记录

### 需求：wan 图生视频工具
系统必须提供 wan 图生视频工具，用户上传单张图片、输入文字描述、选择模型版本、分辨率和时长，系统使用 `alibaba/wan-2.5/image-to-video` 或 `alibaba/wan-2.6/image-to-video` 模型生成视频。

#### 场景：使用 wan 图生视频工具
- **当** 用户在工具页面
- **且** 点击"wan图生视频"工具卡片
- **则** 显示 wan 图生视频表单
- **且** 表单包含：
  - 单图片上传组件（支持上传/粘贴/选择素材）
  - 文字描述输入框
  - 模型版本选择（2.5 或 2.6）
  - 分辨率选择（480p, 720p, 1080p）
  - 时长选择（3-10秒，默认5秒）
  - 是否生成音频选择（复选框）
- **当** 用户上传图片、输入文字描述、选择模型版本、分辨率和时长
- **且** 点击"生成"按钮
- **则** 系统将图片上传到 OSS 获取 URL
- **且** 根据选择的模型版本调用相应的 API
- **且** 系统创建任务并返回任务ID
- **且** 前端开始轮询任务状态
- **且** 任务完成后显示生成的视频
- **且** 生成结果保存到历史记录

#### 场景：模型版本切换
- **当** 用户在 wan 图生视频工具中
- **且** 切换模型版本（2.5 或 2.6）
- **则** 系统根据选择的版本调用相应的 API
- **且** API 参数可能略有不同（如 wan-2.6 需要 `shot_type` 参数）

### 需求：首尾帧生视频工具
系统必须提供首尾帧生视频工具，用户上传2张图片作为首尾帧、输入文字描述、选择分辨率和时长，系统生成视频。

#### 场景：使用首尾帧生视频工具
- **当** 用户在工具页面
- **且** 点击"首尾帧生视频"工具卡片
- **则** 显示首尾帧生视频表单
- **且** 表单包含首帧图片上传、尾帧图片上传、文字输入框、分辨率选择和时长输入
- **当** 用户上传2张图片、输入文字描述、选择分辨率和时长
- **且** 点击"生成"按钮
- **则** 系统创建任务并返回任务ID
- **且** 前端开始轮询任务状态
- **且** 任务完成后显示生成的视频
- **且** 生成结果保存到历史记录

### 需求：生音频工具
系统必须提供生音频工具，用户输入文字描述和选择时长，系统生成音频。

#### 场景：使用生音频工具
- **当** 用户在工具页面
- **且** 点击"生音频"工具卡片
- **则** 显示生音频表单
- **且** 表单包含文字输入框和时长输入
- **当** 用户输入文字描述和时长
- **且** 点击"生成"按钮
- **则** 系统创建任务并返回任务ID
- **且** 前端开始轮询任务状态
- **且** 任务完成后显示生成的音频播放器
- **且** 生成结果保存到历史记录

### 需求：异步任务管理
系统必须为每个工具调用创建异步任务，支持任务状态查询和结果获取。

#### 场景：创建任务
- **当** 用户提交工具表单
- **则** 系统创建任务并返回任务ID
- **且** 任务状态初始为"请求中"（pending）
- **且** 后台异步执行 AI 调用

#### 场景：查询任务状态
- **当** 前端轮询任务状态
- **且** 调用任务状态查询接口
- **则** 系统返回当前任务状态（请求中/成功/失败）
- **且** 如果任务失败，返回错误信息
- **且** 如果任务成功，返回进度信息（可选）

#### 场景：获取任务结果
- **当** 任务状态为"成功"
- **且** 前端调用结果获取接口
- **则** 系统返回完整的输出结果
- **且** 结果包含生成的内容（文本/图片/视频/音频）和元数据

### 需求：状态轮询
系统必须支持前端对任务状态进行轮询。

#### 场景：轮询任务状态
- **当** 任务创建后
- **则** 前端每2秒轮询一次任务状态
- **且** 如果任务状态为"请求中"，继续轮询
- **且** 如果任务状态为"成功"或"失败"，停止轮询
- **且** 如果轮询超过5分钟，停止轮询并提示超时

### 需求：历史记录管理
系统必须记录所有工具生成任务，提供历史记录查看、删除和复用功能。

#### 场景：查看历史记录列表
- **当** 用户在工具页面
- **且** 点击"历史记录"标签
- **则** 显示所有历史记录列表
- **且** 每个记录显示：工具类型、生成时间、输入预览
- **且** 支持按工具类型筛选
- **且** 支持分页显示

#### 场景：动态生成筛选选项
- **当** 用户访问工具页面
- **且** 页面加载完成
- **则** 系统根据 `TOOLS` 数组动态生成历史记录筛选下拉框的选项
- **且** 每个工具在筛选下拉框中都有一个对应的选项
- **且** 选项的 `value` 属性设置为工具的 `id`
- **且** 选项的显示文本设置为工具的 `name`
- **且** "全部工具"选项始终作为第一个选项（value 为空字符串）

#### 场景：筛选功能正确性
- **当** 用户在历史记录筛选下拉框中选择一个工具
- **则** 系统只显示该工具类型的历史记录
- **且** 筛选功能能够正确匹配所有工具类型（包括新增的工具）
- **且** 如果选择"全部工具"，系统显示所有历史记录

#### 场景：工具列表同步
- **当** 系统添加新工具到 `TOOLS` 数组
- **则** 筛选下拉框自动包含新工具的选项
- **且** 无需手动更新筛选下拉框的HTML代码
- **且** 筛选下拉框的选项顺序与 `TOOLS` 数组中的顺序一致

#### 场景：查看历史记录详情
- **当** 用户在历史记录列表中
- **且** 点击"查看详情"按钮
- **则** 显示历史记录详情
- **且** 详情包含：工具类型、输入参数、输出结果、生成时间、任务状态
- **且** 如果输出是图片/视频/音频，显示预览

#### 场景：删除历史记录
- **当** 用户在历史记录列表中
- **且** 点击"删除"按钮
- **且** 确认删除
- **则** 历史记录被删除
- **且** 相关的生成内容文件也被删除（可选）

#### 场景：做同款
- **当** 用户在历史记录列表中
- **且** 点击"做同款"按钮
- **则** 系统跳转到对应的工具表单
- **且** 表单中的输入字段自动填充历史记录中的输入参数
- **且** 如果原始输入包含图片（单图或多图），系统自动将图片填充到对应的图片输入组件
- **且** 用户可以修改输入后重新生成

### 需求：历史记录视频显示
系统必须在历史记录列表中显示视频输出预览。

#### 场景：查看视频历史记录
- **当** 用户在工具页面查看历史记录
- **且** 历史记录的输出包含视频
- **则** 历史记录项显示视频预览（缩略图或第一帧）
- **且** 点击视频预览可以播放视频
- **且** 显示视频相关信息（时长、文件大小等，如果可用）

### 需求：历史记录筛选下拉框动态生成
系统必须根据当前工具列表动态生成历史记录筛选下拉框，确保筛选选项与工具列表保持同步。

#### 场景：动态生成筛选选项
- **当** 用户访问工具页面
- **且** 页面加载完成
- **则** 系统根据 `TOOLS` 数组动态生成历史记录筛选下拉框的选项
- **且** 每个工具在筛选下拉框中都有一个对应的选项
- **且** 选项的 `value` 属性设置为工具的 `id`
- **且** 选项的显示文本设置为工具的 `name`
- **且** "全部工具"选项始终作为第一个选项（value 为空字符串）

#### 场景：筛选功能正确性
- **当** 用户在历史记录筛选下拉框中选择一个工具
- **则** 系统只显示该工具类型的历史记录
- **且** 筛选功能能够正确匹配所有工具类型（包括新增的工具）
- **且** 如果选择"全部工具"，系统显示所有历史记录

#### 场景：工具列表同步
- **当** 系统添加新工具到 `TOOLS` 数组
- **则** 筛选下拉框自动包含新工具的选项
- **且** 无需手动更新筛选下拉框的HTML代码
- **且** 筛选下拉框的选项顺序与 `TOOLS` 数组中的顺序一致

### 需求：生成过程查看详情
系统必须在视频生成过程中支持查看详情功能。

#### 场景：查看生成中任务详情
- **当** 视频生成任务处于"正在处理"状态
- **且** 用户点击"查看详情"按钮
- **则** 系统显示任务详情对话框
- **且** 详情包含：AI 接口的提示词、请求参数
- **且** 用户可以查看当前任务的输入配置

