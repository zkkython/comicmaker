# 素材管理

## Purpose
素材管理提供用户创建、编辑和删除素材资源的功能，包括人物角色、场景和道具。这些素材作为剧集创建的构建块，为内容生成提供视觉参考和元数据。

## Requirements

### 需求：人物角色管理
系统必须允许用户管理人物角色素材，具有以下功能：
- 创建新的人物角色素材
- 编辑现有的人物角色素材
- 删除人物角色素材
- 查看人物角色素材列表

每个人物角色素材应包含：
- 一张主图（必需）
- 0-2 张辅助图片（可选）
- 一个名称（必需）
- 一段文字描述（必需）
- 音色设置（预留未来实现）

#### 场景：创建新人物角色
- **当** 用户导航到人物角色管理页面
- **且** 点击"创建新人物角色"按钮
- **且** 填写名称、描述，上传主图和可选的辅助图片
- **且** 提交表单
- **则** 人物角色素材保存到 `data/materials/characters/{character_id}/`
- **且** 元数据存储在 `meta.json` 中，包含名称、描述、图片路径和音色设置占位符
- **且** 用户重定向到人物角色列表页面

#### 场景：编辑现有人物角色
- **当** 用户查看人物角色列表
- **且** 在人物角色上点击"编辑"
- **且** 修改名称、描述或图片
- **且** 保存更改
- **则** 人物角色元数据在 `meta.json` 中更新
- **且** 如果上传了新图片，新图片替换旧图片
- **且** 更改反映在人物角色列表中

#### 场景：删除人物角色
- **当** 用户查看人物角色列表
- **且** 在人物角色上点击"删除"
- **且** 确认删除
- **则** 人物角色文件夹及其所有内容从 `data/materials/characters/{character_id}/` 移除
- **且** 人物角色从人物角色列表中移除

#### 场景：查看人物角色列表
- **当** 用户导航到人物角色管理页面
- **则** 所有人物角色以列表形式显示
- **且** 每个人物角色显示主图、名称和描述预览
- **且** 每个人物角色有编辑和删除操作可用

### 需求：场景管理
系统必须允许用户管理场景素材，具有以下功能：
- 创建新的场景素材
- 编辑现有的场景素材
- 删除场景素材
- 查看场景素材列表

每个场景素材应包含：
- 一张主图（必需）
- 0-2 张辅助图片（可选）
- 一个名称（必需）
- 一段带关键词的文字描述（必需）

#### 场景：创建新场景
- **当** 用户导航到场景管理页面
- **且** 点击"创建新场景"按钮
- **且** 填写名称、描述关键词，上传主图和可选的辅助图片
- **且** 提交表单
- **则** 场景素材保存到 `data/materials/scenes/{scene_id}/`
- **且** 元数据存储在 `meta.json` 中，包含名称、描述关键词和图片路径
- **且** 用户重定向到场景列表页面

#### 场景：编辑现有场景
- **当** 用户查看场景列表
- **且** 在场景上点击"编辑"
- **且** 修改名称、描述关键词或图片
- **且** 保存更改
- **则** 场景元数据在 `meta.json` 中更新
- **且** 如果上传了新图片，新图片替换旧图片
- **且** 更改反映在场景列表中

#### 场景：删除场景
- **当** 用户查看场景列表
- **且** 在场景上点击"删除"
- **且** 确认删除
- **则** 场景文件夹及其所有内容从 `data/materials/scenes/{scene_id}/` 移除
- **且** 场景从场景列表中移除

#### 场景：查看场景列表
- **当** 用户导航到场景管理页面
- **则** 所有场景以列表形式显示
- **且** 每个场景显示主图、名称和描述关键词预览
- **且** 每个场景有编辑和删除操作可用

### 需求：道具管理
系统必须允许用户管理道具素材，具有以下功能：
- 创建新的道具素材
- 编辑现有的道具素材
- 删除道具素材
- 查看道具素材列表

每个道具素材应包含：
- 一张主图（必需）
- 0-2 张辅助图片（可选）
- 一个名称（必需）
- 一段带关键词的文字描述（必需）

#### 场景：创建新道具
- **当** 用户导航到道具管理页面
- **且** 点击"创建新道具"按钮
- **且** 填写名称、描述关键词，上传主图和可选的辅助图片
- **且** 提交表单
- **则** 道具素材保存到 `data/materials/props/{prop_id}/`
- **且** 元数据存储在 `meta.json` 中，包含名称、描述关键词和图片路径
- **且** 用户重定向到道具列表页面

#### 场景：编辑现有道具
- **当** 用户查看道具列表
- **且** 在道具上点击"编辑"
- **且** 修改名称、描述关键词或图片
- **且** 保存更改
- **则** 道具元数据在 `meta.json` 中更新
- **且** 如果上传了新图片，新图片替换旧图片
- **且** 更改反映在道具列表中

#### 场景：删除道具
- **当** 用户查看道具列表
- **且** 在道具上点击"删除"
- **且** 确认删除
- **则** 道具文件夹及其所有内容从 `data/materials/props/{prop_id}/` 移除
- **且** 道具从道具列表中移除

#### 场景：查看道具列表
- **当** 用户导航到道具管理页面
- **则** 所有道具以列表形式显示
- **且** 每个道具显示主图、名称和描述关键词预览
- **且** 每个道具有编辑和删除操作可用
## 需求
### 需求：其他类型素材管理
系统必须允许用户管理"其他"类型的素材，具有与其他素材类型相同的功能。

#### 场景：创建其他类型素材
- **当** 用户在素材管理页面
- **且** 点击"其他"标签页
- **且** 点击"创建新素材"按钮
- **且** 填写名称、描述，上传主图和可选的辅助图片
- **且** 提交表单
- **则** 素材保存到 `data/materials/others/{material_id}/`
- **且** 元数据存储在 `meta.json` 中，包含名称、描述和图片路径
- **且** 素材显示在"其他"类型的列表中

#### 场景：查看其他类型素材列表
- **当** 用户在素材管理页面
- **且** 点击"其他"标签页
- **则** 所有"其他"类型的素材以列表形式显示
- **且** 每个素材显示主图、名称和描述预览
- **且** 每个素材有编辑和删除操作可用

### 需求：素材选择功能（用于图生图工具）
系统必须在图生图工具中提供素材选择功能，允许用户从素材库中选择图片作为参考图。

#### 场景：打开素材选择面板
- **当** 用户在图生图工具页面
- **且** 在图片上传组件区域看到"选择素材"按钮
- **且** 点击"选择素材"按钮
- **则** 打开素材选择面板（大尺寸模态框）
- **且** 面板显示5个筛选标签：全部、人物、场景、道具、其他
- **且** 默认显示"全部"标签，显示所有类型的素材列表

#### 场景：筛选素材
- **当** 用户在素材选择面板中
- **且** 点击任意筛选标签（全部、人物、场景、道具、其他）
- **则** 加载对应类型的素材列表
- **且** 素材以网格形式显示，每个素材以 1:1 比例显示
- **且** 横版和竖版图片都完整显示，不裁剪

#### 场景：查看素材详情
- **当** 用户在素材选择面板中
- **且** 在素材格子上看到"详情"按钮
- **且** 点击"详情"按钮
- **则** 打开素材详情面板
- **且** 详情面板显示：
  - 素材大图（主图，完整显示）
  - 素材名称
  - 素材描述
  - 右上角关闭按钮
- **且** 点击关闭按钮或点击面板外部区域可关闭详情面板

#### 场景：选择素材
- **当** 用户在素材选择面板中
- **且** 点击素材格子
- **则** 素材被标记为选中状态（视觉反馈，如边框高亮）
- **且** 一次只能选中一个素材
- **且** 点击"选择"按钮
- **则** 获取选中素材的主图
- **且** 将图片添加到图生图工具的图片上传组件中
- **且** 关闭素材选择面板
- **且** 图片显示在图片上传组件的预览区域

#### 场景：取消选择
- **当** 用户在素材选择面板中
- **且** 点击"取消"按钮
- **则** 关闭素材选择面板
- **且** 不进行任何操作

### 需求：创建新素材面板宽度调整
系统必须增加创建新素材面板的宽度，提供更好的编辑体验。

#### 场景：查看创建面板
- **当** 用户在素材管理页面
- **且** 点击"创建新素材"按钮
- **则** 打开创建新素材面板
- **且** 面板宽度比之前增加（例如从 600px 增加到 800px，或使用百分比如 50% 视口宽度）
- **且** 在不同屏幕尺寸下显示正常

### 需求：历史记录"做同款"图片填充

### 需求：通用素材多选面板
系统必须提供一个通用的素材多选面板组件，支持在不同场景下选择多个素材。

#### 场景：打开素材多选面板
- **当** 系统调用 `openMaterialMultiSelectDialog` 函数
- **且** 传入允许的素材类型（可选）
- **则** 显示素材多选面板对话框
- **且** 如果指定了素材类型，只显示对应的筛选标签
- **且** 如果未指定或指定了所有类型，显示所有筛选标签（全部、人物、场景、道具、其他）
- **且** 默认显示"全部"标签的素材列表

#### 场景：多选素材
- **当** 用户在素材多选面板中
- **且** 点击一个素材项
- **则** 如果素材未被选中，将其添加到选中列表并显示勾选标记
- **且** 如果素材已被选中，将其从选中列表移除并隐藏勾选标记
- **且** 选中的素材显示视觉反馈（勾号图标、边框高亮）

#### 场景：筛选素材类型
- **当** 用户在素材多选面板中
- **且** 点击筛选标签（全部、人物、场景、道具、其他）
- **则** 加载对应类型的素材列表
- **且** 更新筛选标签的激活状态
- **且** 保持已选中的素材状态（即使切换筛选标签）

#### 场景：创建新素材
- **当** 用户在素材多选面板中
- **且** 点击"创建素材"按钮
- **则** 系统跳转到素材管理页面（`materials.html`）
- **且** 如果当前有筛选类型，通过 URL 参数传递类型信息
- **且** 素材管理页面可以检测参数并自动打开对应类型的创建面板

#### 场景：刷新素材列表
- **当** 用户在素材多选面板中
- **且** 点击"刷新"按钮
- **则** 系统重新加载当前筛选类型的素材列表
- **且** 保持已选中的素材状态（如果素材仍然存在）

#### 场景：确认选择
- **当** 用户在素材多选面板中选择了素材
- **且** 点击"确认"按钮
- **则** 系统返回选中的素材ID数组
- **且** 通过回调函数传递给调用者
- **且** 关闭对话框

#### 场景：取消选择
- **当** 用户在素材多选面板中
- **且** 点击"取消"按钮或关闭按钮
- **则** 系统关闭对话框
- **且** 不返回任何选中的素材

### 需求：素材多选面板的视觉反馈
系统必须在素材多选面板中提供清晰的视觉反馈，显示哪些素材已被选中。

#### 场景：显示选中状态
- **当** 素材被选中时
- **则** 素材项显示勾号图标（通常在右上角）
- **且** 素材项的边框高亮显示（如蓝色边框）
- **且** 素材项可能有背景色变化（如浅蓝色背景）

#### 场景：显示未选中状态
- **当** 素材未被选中时
- **则** 素材项不显示勾号图标
- **且** 素材项使用默认边框样式
- **且** 素材项使用默认背景色
系统必须在历史记录的"做同款"功能中，如果输入包含图片，将图片填充到工具的图片上传组件中。

#### 场景：做同款时填充图片（图生图工具）
- **当** 用户在历史记录列表中
- **且** 找到一条图生图工具的历史记录
- **且** 该历史记录的输入包含图片（`image_path`、`image_paths`、`images` 等字段）
- **且** 点击"做同款"按钮
- **则** 系统选择图生图工具
- **且** 填充文本字段（如 `prompt`）
- **且** 检测到图片输入字段
- **且** 将图片填充到图生图工具的图片上传组件中
- **且** 图片显示在预览区域
- **且** 用户可以在此基础上修改参数并重新生成

#### 场景：做同款时填充图片（其他工具）
- **当** 用户在历史记录列表中
- **且** 找到一条包含图片输入的工具历史记录（如"参考图生视频"、"首尾帧生视频"等）
- **且** 点击"做同款"按钮
- **则** 系统选择对应工具
- **且** 填充文本字段
- **且** 如果工具支持图片上传，将图片填充到图片上传组件中
- **且** 图片显示在预览区域

