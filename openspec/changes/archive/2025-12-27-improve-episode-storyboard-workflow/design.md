# 改进剧集分镜工作流 - 设计文档

## 架构决策

### 1. 分镜脚本存储格式

**决策**：`storyboard.json` 同时存储原始文本和结构化数据

**理由**：
- 原始文本用于编辑和显示
- 结构化数据用于生成分镜卡片
- 保持向后兼容性

**实现**：
```json
{
  "text": "大段分镜脚本文本...",
  "shots": [
    {
      "id": "...",
      "order": 1,
      "description": "...",
      "image_prompt": "...",
      "video_prompt": "...",
      "audio_prompt": "..."
    }
  ],
  "confirmed": false
}
```

### 2. 工作流阶段

**决策**：分为三个阶段
1. 脚本输入阶段
2. 分镜脚本编辑和确认阶段
3. 分镜卡片生成和管理阶段

**理由**：
- 清晰的用户操作流程
- 允许用户在生成卡片前编辑分镜脚本
- 避免不必要的卡片生成

### 3. 分镜卡片布局

**决策**：使用CSS Grid布局，每行3个卡片

**理由**：
- 响应式设计
- 易于实现滚动
- 良好的视觉效果

**实现**：
```css
.shots-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1.5rem;
}
```

### 4. 分镜卡片字段编辑

**决策**：使用浏览/编辑模式切换

**理由**：
- 清晰的UI状态
- 避免意外编辑
- 更好的用户体验

**实现**：
- 默认显示为只读文本
- 点击"编辑"按钮切换到编辑模式（textarea）
- 编辑后点击"保存"按钮保存更改

## 数据流

1. **生成分镜脚本**：
   - 用户输入脚本 → 调用 `generate_storyboard` API
   - 返回分镜脚本文本 → 保存到 `storyboard.json`（`text` 字段，`confirmed: false`）

2. **编辑分镜脚本**：
   - 用户编辑分镜脚本文本 → 调用 `save_storyboard_text` API
   - 更新 `storyboard.json` 的 `text` 字段

3. **确认分镜脚本**：
   - 用户点击"确认分镜脚本" → 调用 `generate_shots_from_storyboard` API
   - 解析分镜脚本文本，生成结构化数据 → 更新 `storyboard.json`（`shots` 字段，`confirmed: true`）
   - 显示分镜卡片列表

4. **编辑分镜卡片字段**：
   - 用户点击字段的"编辑"按钮 → 切换到编辑模式
   - 用户修改内容 → 点击"保存" → 调用 `update_shot` API
   - 更新 `storyboard.json` 中对应分镜的数据

## API 变更

### 新增端点

1. `POST /api/episodes/{work_id}/{episode_id}/storyboard/text`
   - 保存分镜脚本文本
   - 请求体：`{ "text": "..." }`

2. `POST /api/content/{work_id}/{episode_id}/confirm-storyboard`
   - 确认分镜脚本并生成分镜卡片
   - 请求体：无（使用已保存的分镜脚本文本）

### 修改端点

1. `POST /api/content/{work_id}/{episode_id}/generate-storyboard`
   - 返回格式改为：`{ "text": "...", "confirmed": false }`

2. `GET /api/episodes/{work_id}/{episode_id}/storyboard`
   - 支持返回文本格式：`?format=text`
   - 默认返回结构化数据

## UI/UX 设计

### 页面布局

```
┌─────────────────────────────────────┐
│ 脚本输入区域                         │
│ - 脚本内容（textarea）              │
│ - 预期时长                          │
│ - [保存脚本] [生成分镜脚本]         │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 分镜脚本编辑区域（条件显示）         │
│ - 分镜脚本文本（大段文本，可编辑）  │
│ - [保存分镜脚本] [确认分镜脚本]    │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 分镜卡片列表（条件显示）             │
│ ┌─────┐ ┌─────┐ ┌─────┐            │
│ │卡片1│ │卡片2│ │卡片3│            │
│ └─────┘ └─────┘ └─────┘            │
│ ┌─────┐ ┌─────┐ ┌─────┐            │
│ │卡片4│ │卡片5│ │卡片6│            │
│ └─────┘ └─────┘ └─────┘            │
│ ...（向下滚动）                     │
└─────────────────────────────────────┘
```

### 分镜卡片设计

```
┌─────────────────────────────────────┐
│ 分镜 1                    [生成图片]... │
├─────────────────────────────────────┤
│ 分镜描述：                            │
│ [浏览模式] 描述文本... [编辑]         │
│ [编辑模式] <textarea> [保存] [取消]  │
├─────────────────────────────────────┤
│ 图片提示词：                          │
│ [浏览模式] 提示词文本... [编辑]       │
│ [编辑模式] <textarea> [保存] [取消]  │
├─────────────────────────────────────┤
│ 视频提示词：                          │
│ [浏览模式] 提示词文本... [编辑]       │
│ [编辑模式] <textarea> [保存] [取消]  │
├─────────────────────────────────────┤
│ 音频提示词：                          │
│ [浏览模式] 提示词文本... [编辑]       │
│ [编辑模式] <textarea> [保存] [取消]  │
└─────────────────────────────────────┘
```

## 向后兼容性

- 已存在的 `storyboard.json` 如果只有 `shots` 字段，视为已确认状态
- 如果 `storyboard.json` 不存在，按新流程处理
- 前端检测 `confirmed` 字段，决定显示分镜脚本编辑区域还是分镜卡片列表

