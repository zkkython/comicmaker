# 视频生成工具增强

## 变更 ID
`enhance-video-generation-tools`

## 目的
增强视频生成工具功能，将现有的参考图生视频工具改为 vidu 参考生视频工具，新增 sora 生视频工具，并将现有的图生视频工具改为 wan 图生视频工具，提供更多模型选择和更精细的参数控制。

## 为什么
当前视频生成工具功能有限，只提供了基础的参考图生视频和首尾帧生视频功能，且尚未实现。用户需要更多样化的视频生成选项，包括：
1. 使用 vidu 模型进行多图参考视频生成
2. 使用 sora 模型进行单图视频生成
3. 使用 wan 模型进行单图视频生成，支持版本选择和音频生成选项

这些功能将大大提升用户的视频创作能力和灵活性。

## 变更内容

本次变更主要包括：
1. **vidu 参考生视频工具**：将现有的"参考图生视频"工具改为"vidu参考生视频"工具，使用 `vidu/reference-to-video-q2` 模型，支持最多7张图片输入
2. **sora 生视频工具**：新增"sora生视频"工具，使用 `openai/sora-2/image-to-video` 模型，支持单图输入
3. **wan 图生视频工具**：将现有的"图生视频"工具改为"wan图生视频"工具，支持 `alibaba/wan-2.5/image-to-video` 和 `alibaba/wan-2.6/image-to-video` 两个模型版本
4. **历史记录增强**：历史记录中显示视频输出，做同款时支持图片填充，生成过程中支持查看详情

## 背景

当前系统中有以下视频生成相关的工具定义：
- `text_to_video`：文生视频（尚未实现）
- `ref_image_to_video`：参考图生视频（尚未实现）
- `keyframe_to_video`：首尾帧生视频（尚未实现）

这些工具目前都返回 `NotImplementedError`，需要实际实现。同时，用户需要更多样化的视频生成选项和更精细的参数控制。

## 目标

1. **实现 vidu 参考生视频工具**：
   - 支持最多7张图片输入（上传/粘贴/选择素材）
   - 支持图片拖拽排序和删除
   - 支持分辨率选择（1:1, 3:4, 4:3, 16:9, 9:16）
   - 支持分辨率选择（540p, 720p, 1080p）
   - 支持时长选择（1-10秒，默认5秒）

2. **实现 sora 生视频工具**：
   - 支持单图输入（上传/粘贴/选择素材）
   - 支持时长选择（4、8、12秒）

3. **实现 wan 图生视频工具**：
   - 支持单图输入（上传/粘贴/选择素材）
   - 支持模型版本选择（2.5 或 2.6）
   - 支持分辨率选择（480p, 720p, 1080p）
   - 支持时长选择（3-10秒，默认5秒）
   - 支持是否生成音频选项

4. **增强历史记录功能**：
   - 历史记录列表中显示视频输出预览
   - 做同款时自动填充图片到输入组件
   - 生成过程中支持查看详情（显示请求参数和提示词）

## 影响范围

- **后端**：
  - `server/api/tools.py`：实现三个视频生成工具的执行逻辑
  - `server/utils/video_api.py`：添加 vidu、sora、wan 视频生成 API 函数
  - `server/config/config.yaml`：可能需要添加视频生成相关配置

- **前端**：
  - `apps/web/js/tools.js`：更新工具定义、表单字段、历史记录显示、做同款功能
  - `apps/web/tools.html`：可能需要更新工具列表
  - `apps/web/styles/tools.css`：可能需要添加视频预览样式

## 依赖关系

- 依赖现有的素材选择功能
- 依赖现有的图片上传组件（支持粘贴和素材选择）
- 依赖现有的任务管理系统
- 依赖现有的历史记录功能

## 风险

- 不同视频生成 API 的参数格式可能不同，需要仔细处理
- 视频文件较大，下载和存储可能需要优化
- 多图片上传和排序功能需要确保顺序正确传递到 API
- 视频生成时间较长，需要确保轮询机制稳定

