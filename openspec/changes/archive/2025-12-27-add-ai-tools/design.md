# AI 模型接入工具 - 设计文档

## 架构决策

### 1. 异步任务系统

**决策**：使用任务队列模式，每个 AI 工具调用创建独立任务

**理由**：
- AI 生成任务通常需要较长时间（几秒到几分钟）
- 避免 HTTP 请求超时
- 支持任务状态查询和结果获取
- 便于实现重试和错误处理

**实现**：
- 任务创建：立即返回任务ID
- 任务执行：后台异步执行
- 状态轮询：前端定期查询任务状态
- 结果获取：任务完成后获取结果

### 2. 任务状态管理

**决策**：使用三种状态：`pending`（请求中）、`success`（成功）、`failed`（失败）

**理由**：
- 简单清晰的状态模型
- 易于前端展示和轮询
- 支持错误信息存储

**实现**：
```json
{
  "task_id": "xxx",
  "tool_type": "generate_script",
  "status": "pending|success|failed",
  "input": {...},
  "output": {...},
  "error": "...",
  "created_at": "...",
  "updated_at": "..."
}
```

### 3. 历史记录存储

**决策**：同时存储任务记录和输出记录

**理由**：
- 任务记录：记录完整的生成过程（输入、输出、状态）
- 输出记录：便于快速查看所有生成的内容
- 支持按工具类型、时间等筛选

**实现**：
- 任务记录：`data/tools/tasks/{task_id}.json`
- 历史记录：`data/tools/history/{record_id}.json`
- 生成内容：`data/tools/outputs/{tool_type}/{output_id}/`

### 4. 工具类型定义

**决策**：使用枚举定义工具类型

**理由**：
- 类型安全
- 便于扩展
- 统一管理

**实现**：
```python
class ToolType(str, Enum):
    GENERATE_SCRIPT = "generate_script"  # 生成剧本
    GENERATE_STORYBOARD = "generate_storyboard"  # 生成分镜脚本
    IMAGE_TO_DESCRIPTION = "image_to_description"  # 图生描述
    TEXT_TO_IMAGE = "text_to_image"  # 文生图
    TEXT_TO_VIDEO = "text_to_video"  # 文生视频
    REF_IMAGE_TO_VIDEO = "ref_image_to_video"  # 参考图生视频
    KEYFRAME_TO_VIDEO = "keyframe_to_video"  # 首尾帧生视频
    TEXT_TO_AUDIO = "text_to_audio"  # 生音频
```

### 5. 前端轮询机制

**决策**：使用定时器轮询任务状态，任务完成后停止轮询

**理由**：
- 简单可靠
- 不依赖 WebSocket（减少复杂度）
- 可配置轮询间隔

**实现**：
- 轮询间隔：2秒
- 最大轮询次数：150次（5分钟超时）
- 任务完成后清除定时器

## 数据流

1. **创建任务**：
   - 用户提交工具表单 → 调用 `POST /api/tools/{tool_type}/create`
   - 后端创建任务，返回任务ID
   - 后台异步执行 AI 调用

2. **状态轮询**：
   - 前端每2秒调用 `GET /api/tasks/{task_id}/status`
   - 后端返回任务状态
   - 如果状态为 `success` 或 `failed`，停止轮询

3. **获取结果**：
   - 任务完成后，调用 `GET /api/tasks/{task_id}/result`
   - 后端返回完整的输出结果
   - 前端展示结果并保存到历史记录

4. **历史记录**：
   - 每次任务完成后自动创建历史记录
   - 用户可以在历史记录列表中查看
   - 支持查看详情、删除、做同款

## API 设计

### 工具相关 API

1. `POST /api/tools/{tool_type}/create`
   - 创建任务
   - 请求体：工具特定的输入参数
   - 返回：`{"task_id": "...", "status": "pending"}`

2. `GET /api/tools/{tool_type}/input-schema`
   - 获取工具输入字段定义（用于动态生成表单）

### 任务相关 API

1. `GET /api/tasks/{task_id}/status`
   - 查询任务状态
   - 返回：`{"status": "pending|success|failed", "progress": 0-100, "error": "..."}`

2. `GET /api/tasks/{task_id}/result`
   - 获取任务结果（仅当状态为 success 时）
   - 返回：工具特定的输出结果

### 历史记录 API

1. `GET /api/tools/history`
   - 获取历史记录列表
   - 查询参数：`tool_type`（可选）、`page`、`limit`
   - 返回：历史记录列表和总数

2. `GET /api/tools/history/{record_id}`
   - 获取历史记录详情
   - 返回：完整的输入输出信息

3. `DELETE /api/tools/history/{record_id}`
   - 删除历史记录

4. `GET /api/tools/history/{record_id}/reuse`
   - 获取历史记录的输入参数（用于"做同款"）
   - 返回：工具类型和输入参数

## UI/UX 设计

### 页面布局

```
┌─────────────────────────────────────┐
│ 导航栏：首页 | 素材管理 | 作品管理 | 工具 │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 工具页面                              │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ │
│ │工具卡片1│ │工具卡片2│ │工具卡片3│ │
│ └─────────┘ └─────────┘ └─────────┘ │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ │
│ │工具卡片4│ │工具卡片5│ │工具卡片6│ │
│ └─────────┘ └─────────┘ └─────────┘ │
│ ┌─────────┐ ┌─────────┐            │
│ │工具卡片7│ │工具卡片8│            │
│ └─────────┘ └─────────┘            │
└─────────────────────────────────────┘
```

### 工具卡片设计

```
┌─────────────────────────────────────┐
│ 生成剧本                              │
│ 根据文本描述生成详细剧本文本          │
│ [使用工具]                            │
└─────────────────────────────────────┘
```

### 工具表单设计

```
┌─────────────────────────────────────┐
│ 生成剧本                              │
├─────────────────────────────────────┤
│ 文本描述：                            │
│ [多行文本输入框]                      │
│                                      │
│ [生成] [取消]                        │
└─────────────────────────────────────┘
```

### 任务状态展示

```
┌─────────────────────────────────────┐
│ 任务进行中...                         │
│ [进度条] 50%                         │
│ 预计剩余时间：30秒                    │
└─────────────────────────────────────┘
```

### 历史记录列表

```
┌─────────────────────────────────────┐
│ 历史记录                              │
│ [筛选：全部 | 生成剧本 | ...]        │
├─────────────────────────────────────┤
│ 生成剧本 - 2025-12-27 10:30          │
│ 输入：一个关于...                     │
│ [查看详情] [删除] [做同款]            │
├─────────────────────────────────────┤
│ 文生图 - 2025-12-27 10:25           │
│ 输入：一只可爱的小猫...               │
│ [查看详情] [删除] [做同款]            │
└─────────────────────────────────────┘
```

## 文件组织

### 数据存储结构

```
data/tools/
├── tasks/
│   └── {task_id}.json          # 任务数据
├── history/
│   └── {record_id}.json        # 历史记录
└── outputs/
    ├── generate_script/
    │   └── {output_id}/
    │       └── script.txt
    ├── text_to_image/
    │   └── {output_id}/
    │       └── image.jpg
    ├── text_to_video/
    │   └── {output_id}/
    │       └── video.mp4
    └── ...
```

## 向后兼容性

- 不影响现有的剧集编辑流程
- 工具页面是新增功能，不修改现有页面
- 历史记录独立存储，不影响现有数据

