# API 测试

## Purpose
API 测试提供对 ComicMaker 后端所有 API 接口的系统化测试能力，包括单元测试、接口测试，以及可视化的测试管理界面。确保 API 的可靠性和正确性，并为后续 AI 接口测试提供扩展基础。

## 新增需求

### 需求：测试框架和基础设施
系统必须提供测试框架和基础设施支持，包括：
- 测试依赖管理
- 测试目录结构
- 测试工具模块（测试客户端、数据清理等）
- 测试数据管理（独立的测试作品、剧集等）

#### 场景：测试环境初始化
- **当** 运行测试时
- **则** 系统自动创建测试数据目录
- **且** 测试数据与生产数据完全隔离
- **且** 测试前后自动清理测试数据

#### 场景：测试客户端使用
- **当** 编写测试用例时
- **则** 可以使用测试工具模块提供的测试客户端
- **且** 测试客户端支持异步请求
- **且** 测试客户端自动处理认证和错误处理

### 需求：素材管理 API 测试
系统必须为素材管理 API 提供完整的测试覆盖，包括：
- 人物角色、场景、道具的 CRUD 操作测试
- 文件上传和验证测试
- 错误处理测试（无效类型、缺失资源等）

#### 场景：测试人物角色创建
- **当** 执行人物角色创建测试
- **且** 提供有效的名称、描述和主图
- **则** 测试验证创建成功
- **且** 验证返回的数据结构正确
- **且** 验证文件已正确保存

#### 场景：测试素材列表查询
- **当** 执行素材列表查询测试
- **且** 已创建多个测试素材
- **则** 测试验证返回的列表包含所有素材
- **且** 验证每个素材的数据结构完整

#### 场景：测试素材删除
- **当** 执行素材删除测试
- **且** 指定要删除的素材 ID
- **则** 测试验证删除成功
- **且** 验证相关文件已删除
- **且** 验证再次查询时素材不存在

#### 场景：测试无效素材类型
- **当** 使用无效的素材类型调用 API
- **则** 测试验证返回 400 错误
- **且** 验证错误消息清晰明确

### 需求：作品管理 API 测试
系统必须为作品管理 API 提供完整的测试覆盖，包括：
- 作品列表和详情查询测试
- 作品创建、更新、删除测试
- 封面图片上传测试
- 宽高比设置验证测试

#### 场景：测试作品创建流程
- **当** 执行作品创建测试
- **且** 提供有效的名称和描述
- **则** 测试验证创建成功
- **且** 验证返回的作品 ID 有效
- **且** 验证默认值设置正确（宽高比、风格描述等）

#### 场景：测试作品更新
- **当** 执行作品更新测试
- **且** 修改名称、描述、风格描述和宽高比
- **则** 测试验证更新成功
- **且** 验证所有字段已正确更新
- **且** 验证宽高比值在允许范围内

#### 场景：测试封面图片上传
- **当** 执行封面图片上传测试
- **且** 上传一张或多张图片
- **则** 测试验证上传成功
- **且** 验证图片文件已保存
- **且** 验证元数据中记录了图片路径

### 需求：剧集管理 API 测试
系统必须为剧集管理 API 提供完整的测试覆盖，包括：
- 剧集列表和详情查询测试
- 剧集创建、更新、删除测试
- 脚本保存和读取测试
- 分镜脚本生成和读取测试

#### 场景：测试剧集创建
- **当** 执行剧集创建测试
- **且** 在测试作品中创建新剧集
- **则** 测试验证创建成功
- **且** 验证剧集文件夹结构正确
- **且** 验证元数据文件已创建

#### 场景：测试脚本保存和读取
- **当** 执行脚本保存测试
- **且** 提供脚本内容和预期时长
- **则** 测试验证保存成功
- **且** 验证脚本文件已创建
- **且** 验证读取时内容一致

#### 场景：测试分镜脚本生成
- **当** 执行分镜脚本生成测试
- **且** 提供有效的脚本内容
- **则** 测试验证生成成功
- **且** 验证返回的分镜结构正确
- **且** 验证分镜脚本文件已保存

### 需求：内容生成 API 测试
系统必须为内容生成 API 提供完整的测试覆盖，包括：
- 分镜生成接口测试
- 图片生成接口测试
- 图片选择接口测试
- 视频生成接口测试
- 音频生成接口测试
- 提示词更新接口测试
- 分镜详情查询接口测试

#### 场景：测试图片生成
- **当** 执行图片生成测试
- **且** 提供有效的图片提示词
- **则** 测试验证生成请求成功
- **且** 验证返回候选图片路径
- **且** 验证分镜元数据已更新

#### 场景：测试图片选择
- **当** 执行图片选择测试
- **且** 从候选图片中选择一张
- **则** 测试验证选择成功
- **且** 验证分镜元数据中记录了选中的图片

#### 场景：测试提示词更新
- **当** 执行提示词更新测试
- **且** 更新图片、视频或音频提示词
- **则** 测试验证更新成功
- **且** 验证分镜元数据中提示词已更新

### 需求：命令行测试脚本
系统必须提供命令行测试脚本入口，支持：
- 批量执行所有测试用例
- 按模块执行测试
- 输出测试结果统计（通过/失败数量）
- 支持测试数据清理选项

#### 场景：执行所有测试
- **当** 运行测试脚本
- **且** 不指定模块参数
- **则** 脚本执行所有测试用例
- **且** 输出每个测试用例的执行结果
- **且** 最后输出统计信息（总数、通过数、失败数）

#### 场景：按模块执行测试
- **当** 运行测试脚本
- **且** 指定模块参数（如 materials）
- **则** 脚本仅执行指定模块的测试用例
- **且** 输出该模块的测试结果统计

#### 场景：测试数据清理
- **当** 运行测试脚本
- **且** 指定清理选项
- **则** 脚本在测试前清理测试数据目录
- **且** 测试后再次清理测试数据

### 需求：前端测试页面
系统必须提供前端测试页面，支持：
- 显示所有测试用例列表
- 单个用例执行和结果展示
- 批量执行所有用例
- 查看测试详情（输入输出、请求响应）

#### 场景：查看测试用例列表
- **当** 用户访问测试页面
- **则** 页面显示所有测试用例的列表
- **且** 每个用例显示名称、模块、状态（未执行/通过/失败）
- **且** 每个用例有单独的执行按钮

#### 场景：执行单个测试用例
- **当** 用户点击单个用例的执行按钮
- **则** 页面显示该用例的执行状态（运行中）
- **且** 用例执行完成后显示结果（通过/失败）
- **且** 可以点击查看详情，显示输入输出和请求响应

#### 场景：批量执行所有测试
- **当** 用户点击"执行所有测试"按钮
- **则** 页面依次执行所有测试用例
- **且** 实时更新每个用例的状态
- **且** 显示执行进度
- **且** 执行完成后显示总体统计（通过数/失败数）

#### 场景：查看测试详情
- **当** 用户点击测试用例的"查看详情"按钮
- **则** 页面显示该用例的详细信息
- **且** 包括：请求方法、请求路径、请求参数、响应状态码、响应数据
- **且** 如果测试失败，显示错误信息

### 需求：测试 API 接口
系统必须提供测试相关的 API 接口，支持：
- 获取测试用例列表
- 执行单个测试用例
- 批量执行测试用例
- 获取测试结果详情

#### 场景：获取测试用例列表
- **当** 前端调用测试用例列表接口
- **则** 接口返回所有测试用例的元数据
- **且** 包括：用例 ID、名称、模块、描述

#### 场景：执行单个测试用例
- **当** 前端调用单个用例执行接口
- **且** 提供用例 ID
- **则** 接口执行该测试用例
- **且** 返回执行结果（通过/失败、响应数据、错误信息）

#### 场景：批量执行测试用例
- **当** 前端调用批量执行接口
- **且** 可选指定模块参数
- **则** 接口依次执行所有测试用例
- **且** 返回每个用例的执行结果
- **且** 返回总体统计信息

