## 修改需求
### 需求：输入剧本并生成分镜脚本文本
系统必须允许用户输入剧本文本、预期时长，并调用生成单镜头分镜脚本工具生成格式化的分镜脚本。

#### 场景：输入剧本并生成单镜头分镜脚本
- **当** 用户在剧集编辑页面
- **且** 在输入框中输入剧本文本
- **且** 设置预期剧集时长
- **且** 保存剧本
- **则** 剧本保存到 `data/works/{work_id}/episodes/{episode_id}/script.json`
- **且** 剧本文本和预期时长被存储
- **当** 用户点击"生成单镜头分镜脚本"按钮
- **则** 系统调用生成单镜头分镜脚本工具
- **且** 工具使用以下参数：
  - 剧本文本（从输入框获取）
  - 预期时长（从输入框获取，默认60秒）
  - 单镜头预计时间（用户选择，1-6秒）
  - 关联素材（从作品关联的素材中获取：人物、场景、道具）
- **且** 工具返回格式化的分镜脚本文本
- **且** 分镜脚本文本保存到 `storyboard.json` 的 `text` 字段
- **且** `confirmed` 字段设置为 `false`
- **且** 分镜脚本编辑区域显示，允许用户查看和编辑分镜脚本文本
- **且** 剧本输入框变为只读，显示"重新编辑剧本"按钮

#### 场景：生成多镜头分镜脚本（预留）
- **当** 用户在剧集编辑页面
- **且** 点击"生成多镜头分镜脚本"按钮
- **则** 系统显示提示信息（功能开发中）
- **注意**：此功能暂时不实现，仅预留按钮

#### 场景：显示剧本关联素材列表
- **当** 分镜脚本已生成
- **且** 系统解析分镜脚本的第一行（"剧本关联素材：..."）
- **则** 在分镜脚本编辑区域上方显示剧本关联素材列表
- **且** 每个素材显示名称和图片
- **且** 每个素材可以点击查看详情（打开素材详情对话框）

### 需求：生成分镜卡片
系统必须解析格式化的分镜脚本文本，生成结构化分镜数据，并创建分镜卡片。

#### 场景：解析分镜脚本并生成分镜卡片
- **当** 分镜脚本文本已保存
- **且** 用户点击"生成分镜"按钮
- **则** 系统解析分镜脚本文本，提取：
  - 剧本关联素材列表（第一行）
  - 每个分镜的描述、关联素材、时长
- **且** 如果解析失败，显示错误提示面板，不创建分镜卡片
- **且** 如果解析成功，为每个分镜创建结构化数据：
  - `id`：分镜ID（自动生成）
  - `description`：分镜描述
  - `related_materials`：关联素材列表
  - `duration`：预期时长（秒）
  - `image_prompt`：空（后续生成）
  - `video_prompt`：空（后续生成）
  - `reference_video_prompt`：空（后续生成）
  - `audio_prompt`：空（后续生成）
  - `dialogue_prompt`：空（后续生成）
- **且** 结构化数据保存到 `storyboard.json` 的 `shots` 字段
- **且** `confirmed` 字段设置为 `true`
- **且** `related_materials` 字段保存剧本关联素材列表
- **且** 基于结构化数据创建分镜卡片列表
- **且** 分镜脚本编辑区域隐藏，分镜卡片列表区域显示

### 需求：查看分镜卡片字段（浏览模式）
系统必须在分镜卡片中显示分镜描述、预期时长和提示词字段。

#### 场景：查看分镜卡片字段
- **当** 分镜卡片已显示
- **则** 每个分镜卡片包含以下字段：
  - 分镜描述（总体描述）
  - 预期时长（1-6秒下拉框，可编辑）
  - 图片提示词（在图片Tab中）
  - 视频提示词（在视频Tab中）
  - 参考视频提示词（在参考Tab中）
  - 音频提示词（在音频Tab中）
  - 台词提示词（在音频Tab中）
- **且** 分镜描述单独显示
- **且** 预期时长显示在分镜描述下方（下拉框，默认显示生成的分镜时长）
- **且** 图片、视频、参考、音频四个提示词通过Tab切换显示
- **且** 每个字段默认以浏览模式显示（只读文本）
- **且** 每个字段旁边显示"编辑"按钮

## 新增需求
### 需求：分镜卡片生成提示词
系统必须允许用户为每个分镜生成提示词，并自动填充到对应的字段中。

#### 场景：生成分镜提示词
- **当** 用户在分镜卡片上点击"生成提示词"按钮
- **则** 系统调用生成分镜提示词工具
- **且** 工具使用以下参数：
  - 关联素材列表（从分镜的 `related_materials` 获取）
  - 分镜描述（从分镜的 `description` 获取）
  - 预期时长（从分镜的 `duration` 获取）
- **且** 工具返回5个提示词
- **且** 系统将提示词填充到对应字段：
  - 分镜图片提示词 -> 图片Tab的图片提示词
  - 分镜视频提示词 -> 视频Tab的视频提示词
  - 参考视频提示词 -> 参考Tab的视频提示词
  - 音频提示词 -> 音频Tab的音频提示词
  - 台词提示词 -> 音频Tab的台词提示词
- **且** 提示词保存到 `storyboard.json` 中对应分镜的数据

### 需求：分镜卡片参考视频生成
系统必须允许用户为每个分镜生成参考视频，使用vidu参考生视频工具。

#### 场景：生成参考视频
- **当** 用户在分镜卡片的"参考"Tab中
- **且** 点击"生成视频"按钮
- **则** 系统调用vidu参考生视频工具
- **且** 工具使用以下参数：
  - 描述（从分镜的 `reference_video_prompt` 获取，如果为空则使用 `video_prompt`）
  - 图片列表（从分镜的 `related_materials` 获取，提取每个素材的主图，按顺序）
  - 比例（从作品的 `aspect_ratio` 获取）
  - 时长（从分镜的 `duration` 获取）
- **且** 系统创建任务并返回任务ID
- **且** 任务ID保存到分镜的 `video_task_id` 字段
- **且** 前端开始轮询任务状态
- **且** 任务完成后，视频URL保存到分镜的 `current_video` 字段
- **且** 视频添加到分镜的 `video_history` 列表
- **且** 视频在"参考"Tab中显示

#### 场景：查询任务状态并关联视频
- **当** 用户离开剧集编辑页面后再次进入
- **且** 分镜的 `video_task_id` 字段存在
- **且** `current_video` 字段为空
- **则** 系统查询任务状态
- **且** 如果任务已完成，将视频URL保存到 `current_video` 字段
- **且** 视频添加到 `video_history` 列表
- **且** 清除 `video_task_id` 字段

#### 场景：重新生成参考视频
- **当** 用户在分镜卡片的"参考"Tab中
- **且** 点击"生成视频"按钮
- **且** 分镜已有 `current_video`
- **则** 系统生成新视频
- **且** 新视频生成成功后，替换 `current_video` 字段
- **且** 旧视频保留在 `video_history` 列表中

#### 场景：查看参考视频历史
- **当** 用户在分镜卡片的"参考"Tab中
- **且** 点击"历史"按钮
- **则** 系统打开视频历史面板
- **且** 面板左侧显示所有历史视频列表（按生成时间倒序）
- **且** 面板右侧显示当前选中视频的预览播放器
- **且** 播放器支持进度条调整和时长显示
- **当** 用户点击列表中的其他视频
- **则** 右侧预览播放器切换显示该视频
- **当** 用户点击"更改"按钮
- **则** 系统将选中的视频设置为 `current_video`
- **且** 更新页面显示
- **且** 关闭历史面板

