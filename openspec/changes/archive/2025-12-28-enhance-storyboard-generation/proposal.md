# 增强分镜生成和提示词生成功能

## 变更 ID
`enhance-storyboard-generation`

## 目的
增强分镜生成工具，支持单镜头分镜脚本生成（包含素材选择、时长计算），新增分镜提示词生成工具，并迭代分镜卡片功能（预期时长、生成提示词、参考视频生成）。

## 为什么
- 用户需要基于作品关联的素材生成分镜脚本，确保分镜与素材一致
- 用户需要根据预期时长和单镜头时长自动计算分镜数量
- 用户需要为每个分镜生成详细的提示词（图片、视频、参考视频、音频、台词）
- 用户需要为分镜生成参考视频，支持多图片输入
- 用户需要在分镜卡片中管理预期时长和视频历史

## 变更内容

### 1. 修改"生成分镜脚本"工具为"生成单镜头分镜脚本"
- 工具名称改为"生成单镜头分镜脚本"
- 添加输入字段：
  - 预期时长（默认60秒）
  - 单镜头预计时间（1-6秒下拉框）
- 添加素材选择功能（与作品详情页相同）：
  - 人物素材列表、添加人物素材按钮
  - 场景素材列表、添加场景素材按钮
  - 道具素材列表、添加道具素材按钮
- 优化提示词，包含：
  - 素材列表（3个类别分别列出）
  - 预期时长和单镜头时长（用于计算分镜数量）
  - 格式化输出要求（包含关联素材、分镜描述、关联素材、时长）
- 输出解析和结构化展示

### 2. 剧集编辑页面增强
- 将"生成分镜脚本"按钮改为"生成单镜头分镜脚本"
- 添加"生成多镜头分镜脚本"按钮（预留）
- 点击"生成单镜头分镜脚本"调用工具能力
- 解析分镜脚本并创建分镜卡片
- 显示剧本关联素材列表（可点击查看详情）

### 3. 新增"生成分镜提示词"工具
- 输入字段：
  - 关联素材列表（多选，支持素材选择面板）
  - 分镜描述
  - 预期时长（1-12秒下拉框）
- 输出5个提示词：
  - 分镜图片提示词
  - 分镜视频提示词
  - 参考视频提示词
  - 音频提示词
  - 台词提示词
- 输出解析和结构化展示

### 4. 分镜卡片迭代
- 添加预期时长显示和编辑（1-6秒下拉框）
- 添加"生成提示词"按钮（调用生成分镜提示词工具）
- 添加"参考"tab，支持vidu参考生视频
- 视频历史管理（历史列表、预览播放、切换视频）

## 背景
- 项目已有"生成分镜脚本"工具（基础实现）
- 项目已有素材多选面板（在作品详情页使用）
- 项目已有vidu参考生视频工具
- 项目已有分镜卡片基础功能
- 剧集编辑页面已有分镜脚本生成流程

## 变更范围
- **后端代码**：
  - 修改 `server/api/tools.py`（修改生成分镜脚本工具，新增生成分镜提示词工具）
  - 修改 `server/api/content.py`（修改分镜生成接口，支持新参数）
  - 新增/修改提示词模板文件
- **前端代码**：
  - 修改 `apps/web/js/tools.js`（工具定义和表单）
  - 修改 `apps/web/js/episode-edit.js`（剧集编辑逻辑）
  - 修改 `apps/web/episode-edit.html`（UI调整）
- **规范**：
  - 修改 `openspec/specs/ai-tools/spec.md`（工具需求）
  - 修改 `openspec/specs/episode-management/spec.md`（剧集编辑需求）

## 技术细节
- 分镜脚本输出格式需要严格解析（正则表达式或文本解析）
- 分镜提示词输出格式需要严格解析（5个提示词分别提取）
- 素材列表需要从作品关联的素材中获取
- 视频历史需要关联到分镜卡片，支持任务状态查询
- 参考视频生成需要将分镜关联素材的主图作为图片列表

