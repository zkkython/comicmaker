# 设计文档

## 架构决策

### 1. 分镜脚本输出格式解析

分镜脚本的输出格式需要严格解析，格式如下：

```
剧本关联素材：素材1，素材2，素材3
分镜1: 分镜描述文本
关联素材: 素材1，素材2
时长: 5
分镜2: 分镜描述文本
关联素材: 素材3
时长: 6
```

解析策略：
- 使用正则表达式匹配"剧本关联素材："行
- 使用正则表达式匹配"分镜N:"行
- 使用正则表达式匹配"关联素材:"和"时长:"行
- 如果解析失败，显示错误提示，不创建分镜卡片

### 2. 分镜提示词输出格式解析

分镜提示词的输出格式需要严格解析，格式如下：

```
分镜图片提示词: 提示词内容
分镜视频提示词: 提示词内容
参考视频提示词: 提示词内容
音频提示词: 提示词内容
台词提示词: 提示词内容
```

解析策略：
- 使用正则表达式匹配每个提示词类型
- 提取冒号后的内容作为提示词文本
- 如果某个提示词缺失，显示占位符或错误提示

### 3. 素材列表管理

- 素材列表从作品关联的素材中获取（`meta.json` 中的 `character_materials`、`scene_materials`、`prop_materials`）
- 在生成分镜脚本工具中，用户可以选择素材，这些素材会传递给LLM
- 在剧集编辑页面，显示剧本关联的素材列表（从解析的分镜脚本中提取）

### 4. 视频历史管理

- 每个分镜卡片关联一个视频历史列表
- 视频历史存储在分镜的元数据中（`meta.json` 的 `video_history` 字段）
- 当前使用的视频存储在 `current_video` 字段
- 任务ID存储在 `video_task_id` 字段，用于查询任务状态

### 5. 参考视频生成

- 使用vidu参考生视频工具（`vidu_ref_image_to_video`）
- 将分镜关联素材的主图作为图片列表（按顺序）
- 使用分镜的预期时长作为视频时长
- 使用作品的比例作为视频比例
- 视频提示词作为描述字段

## 数据模型

### 分镜脚本数据结构

```json
{
  "text": "分镜脚本文本",
  "confirmed": false,
  "related_materials": ["素材1", "素材2"],
  "shots": [
    {
      "id": "shot_1",
      "description": "分镜描述",
      "related_materials": ["素材1", "素材2"],
      "duration": 5,
      "image_prompt": "...",
      "video_prompt": "...",
      "reference_video_prompt": "...",
      "audio_prompt": "...",
      "dialogue_prompt": "...",
      "current_video": "video_path",
      "video_task_id": "task_id",
      "video_history": [
        {
          "video_path": "path",
          "generated_at": "timestamp"
        }
      ]
    }
  ]
}
```

## 提示词模板设计

### 生成单镜头分镜脚本提示词

- 包含剧本内容
- 包含素材列表（3个类别分别列出）
- 包含预期时长和单镜头时长
- 要求AI根据时长计算分镜数量
- 要求AI选择需要关联的素材
- 要求严格按照格式输出

### 生成分镜提示词提示词

- 包含关联素材列表（按顺序描述）
- 包含分镜描述
- 包含预期时长
- 要求AI生成5个提示词（图片、视频、参考视频、音频、台词）
- 要求AI在提示词中描述素材的使用方式
- 要求严格按照格式输出

