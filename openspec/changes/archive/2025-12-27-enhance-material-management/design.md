# 设计文档

## 架构决策

### 1. 素材选择面板的实现方式

**决策**：使用 HTML5 `<dialog>` 元素实现素材选择面板

**理由**：
- 与项目中其他模态框的实现方式保持一致
- 原生支持，无需额外的 JavaScript 库
- 支持无障碍访问

**实现**：
- 在 `tools.html` 中添加 `<dialog id="material-select-dialog">` 元素
- 使用 CSS 控制面板大小和位置
- 使用 JavaScript 控制打开/关闭和交互逻辑

### 2. 素材图片的显示方式

**决策**：使用 1:1 固定比例的容器，图片使用 `object-fit: contain` 保证完整显示

**理由**：
- 1:1 比例提供统一的视觉效果，便于网格布局
- `object-fit: contain` 确保图片不被裁剪，完整显示
- 支持横版、竖版、正方形图片的统一显示

**实现**：
```css
.material-grid-item {
    aspect-ratio: 1 / 1;
    overflow: hidden;
}
.material-grid-item img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}
```

### 3. 素材选择后的处理方式

**决策**：将选中素材的主图添加到图生图工具的图片上传组件中，复用现有的多图片管理逻辑

**理由**：
- 复用现有的 `initImageListUpload` 和 `imageListData` 逻辑
- 保持与手动上传图片的一致性
- 减少代码重复

**实现**：
- 获取选中素材的主图路径（通过 API 获取完整路径或 URL）
- 将图片转换为 File 对象或直接使用 URL
- 调用现有的图片添加逻辑，将图片添加到 `imageListData` 中
- 触发 `renderImageList` 更新显示

### 4. 历史记录"做同款"的图片处理

**决策**：检测图片输入字段，将图片路径转换为可用的图片对象并填充到图片上传组件

**理由**：
- 提升用户体验，减少重复操作
- 与文本字段的填充逻辑保持一致

**实现**：
- 在 `reuseHistory` 函数中检测 `image_path`、`image_paths`、`images` 等字段
- 对于图生图工具，将图片路径转换为 File 对象或 URL
- 调用图片添加逻辑，填充到图片上传组件
- 确保图片正确显示在预览区域

### 5. 素材筛选的实现方式

**决策**：使用标签页（tab）实现筛选，每个标签对应一个素材类型

**理由**：
- 界面清晰，用户易于理解
- 与素材管理页面的实现方式保持一致
- 实现简单，性能良好

**实现**：
- 5个标签：全部、人物、场景、道具、其他
- 点击标签时，调用 API 获取对应类型的素材列表
- 更新素材网格显示

## 数据流

### 素材选择流程

1. 用户点击"选择素材"按钮
2. 打开素材选择面板
3. 默认显示"全部"标签的素材列表
4. 用户点击筛选标签，切换素材类型
5. 用户点击素材格子，标记为选中
6. 用户点击"详情"按钮，查看素材详情
7. 用户点击"选择"按钮
8. 获取选中素材的主图
9. 将图片添加到图生图工具的图片上传组件
10. 关闭素材选择面板

### 历史记录"做同款"流程

1. 用户点击历史记录的"做同款"按钮
2. 调用 API 获取历史记录的输入参数
3. 选择对应的工具
4. 填充文本字段
5. 检测图片输入字段
6. 如果是图生图工具且有图片，将图片填充到图片上传组件
7. 更新预览显示

## UI/UX 考虑

### 素材选择面板

- **尺寸**：大尺寸面板（例如 80% 视口宽度，70% 视口高度），确保有足够的空间显示素材网格
- **布局**：
  - 顶部：标题栏和关闭按钮
  - 中部：筛选标签和素材网格
  - 底部：操作按钮（选择、取消）
- **交互**：
  - 素材选中状态：使用边框高亮或背景色变化
  - 详情按钮：位于素材格子下方，鼠标悬停时显示
  - 图片加载：显示加载状态，加载失败时显示占位符

### 素材网格

- **布局**：响应式网格，根据面板宽度自动调整列数
- **间距**：适当的间距，确保视觉清晰
- **图片显示**：1:1 比例，完整显示，不裁剪

### 创建新素材面板

- **宽度**：从 600px 增加到 800px（或使用百分比，如 50% 视口宽度）
- **响应式**：在小屏幕上自动调整宽度

