# 作品素材关联功能

## 变更 ID
`add-work-material-association`

## 目的
为作品添加素材关联功能，允许用户为每个作品关联人物、场景和道具素材。同时创建一个通用的素材多选面板组件，支持在不同场景下使用。

## 为什么
当前系统缺少作品与素材之间的关联机制。用户需要能够：
1. 为作品指定使用的人物角色、场景和道具
2. 在作品详情页面管理这些关联关系
3. 通过一个通用的多选面板组件选择素材

这将为后续的内容生成提供上下文，帮助系统更好地理解作品的需求。

## 变更内容

本次变更主要包括：
1. **通用素材多选面板**：创建一个可复用的素材多选面板组件，支持：
   - 多选功能（点击勾选/取消勾选）
   - 可配置的素材分类筛选（支持只显示特定类型的素材）
   - 创建素材按钮（跳转到素材管理页面）
   - 刷新按钮（重新加载素材列表）
2. **作品素材关联功能**：在作品详情页面添加：
   - 人物素材列表显示和管理
   - 场景素材列表显示和管理
   - 道具素材列表显示和管理
   - 每个分类都有"添加素材"按钮，打开对应的多选面板

## 背景

当前系统已有：
- 素材管理功能（人物、场景、道具、其他）
- 作品详情编辑页面（基本信息编辑）
- 素材单选面板（在工具页面使用，用于图生图工具）

需要新增：
- 素材多选面板组件
- 作品与素材的关联数据存储
- 作品详情页面的素材管理界面

## 目标

1. **实现通用素材多选面板**：
   - 支持多选（勾选/取消勾选）
   - 支持配置素材分类（全部/人物/场景/道具/其他）
   - 显示素材名称和图片
   - 提供"创建素材"按钮（跳转到素材管理页面）
   - 提供"刷新"按钮（重新加载素材列表）
   - 提供"确认"和"取消"按钮

2. **实现作品素材关联**：
   - 在作品 `meta.json` 中存储关联的素材ID列表
   - 在作品详情页面显示三个分类的素材列表
   - 每个分类提供"添加素材"按钮
   - 添加时去重，确保每个素材只关联一次
   - 支持删除已关联的素材

3. **后端API支持**：
   - 更新作品时保存素材关联信息
   - 获取作品时返回关联的素材信息

## 影响范围

- **后端**：
  - `server/api/works.py`：更新作品创建和更新接口，支持素材关联字段
  - `server/api/materials.py`：可能需要添加批量获取素材详情的接口

- **前端**：
  - `apps/web/work-detail.html`：添加素材管理区域
  - `apps/web/js/works.js`：添加素材管理逻辑
  - `apps/web/js/tools.js`：创建通用的素材多选面板组件（或新建独立文件）
  - `apps/web/styles/tools.css` 或新建样式文件：多选面板样式

- **数据存储**：
  - `data/works/{work_id}/meta.json`：添加 `character_materials`、`scene_materials`、`prop_materials` 字段

## 依赖关系

- 依赖现有的素材管理功能
- 依赖现有的作品管理功能
- 复用现有的素材选择面板的部分代码和样式

## 风险

- 多选面板的UI/UX需要确保清晰易用
- 素材关联数据的去重逻辑需要确保正确
- 跳转到素材管理页面后返回时，需要保持作品详情页面的状态

